{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/chelseygowac/book-tracker-app/src/app/api/statistics/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { NextRequest, NextResponse } from 'next/server';\n\ninterface MonthlyTrend {\n  month: string;\n  booksRead: number;\n  pagesRead: number;\n}\n\ninterface GenreStats {\n  genre: string;\n  count: number;\n  percentage: number;\n}\n\ninterface Book {\n  id: string;\n  title: string;\n  author: string;\n  genres: string[];\n  page_count: number;\n}\n\ninterface UserBook {\n  id: string;\n  rating: number;\n  completed_at: string;\n  status: string;\n  books: Book;\n}\n\ninterface TopRatedBook {\n  title: string;\n  rating: number;\n  author: string;\n}\n\nexport async function GET(request: NextRequest) {\n  try {\n    const authHeader = request.headers.get('Authorization');\n    if (!authHeader?.startsWith('Bearer ')) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const token = authHeader.substring(7);\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        global: {\n          headers: {\n            Authorization: `Bearer ${token}`,\n          },\n        },\n      }\n    );\n\n    const {\n      data: { user },\n    } = await supabase.auth.getUser();\n\n    if (!user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    const currentYear = new Date().getFullYear();\n    const currentDate = new Date();\n\n    const { data, error: booksError } = await supabase\n      .from('user_books')\n      .select(\n        `\n        id,\n        rating,\n        completed_at,\n        status,\n        books (\n          id,\n          title,\n          author,\n          genres,\n          page_count\n        )\n      `\n      )\n      .eq('user_id', user.id)\n      .eq('status', 'READ')\n      .order('completed_at', { ascending: false });\n\n    if (booksError) throw booksError;\n\n    // Cast the data, accounting for Supabase's response format\n    const userBooks: UserBook[] = (data || []) as unknown as UserBook[];\n\n    if (!userBooks || userBooks.length === 0) {\n      return NextResponse.json({\n        yearlyTrends: generateEmptyMonths(),\n        genreBreakdown: [],\n        readingStreak: 0,\n        topRatedBooks: [],\n        totalBooksRead: 0,\n        totalPagesRead: 0,\n        averageRating: 0,\n        thisMonthBooks: 0,\n        thisYearBooks: 0,\n      });\n    }\n\n    const yearlyBooks = userBooks.filter(\n      (ub) =>\n        ub.completed_at &&\n        new Date(ub.completed_at).getFullYear() === currentYear\n    );\n\n    const thisMonthBooks = userBooks.filter((ub) => {\n      if (!ub.completed_at) return false;\n      const completed = new Date(ub.completed_at);\n      return (\n        completed.getFullYear() === currentYear &&\n        completed.getMonth() === currentDate.getMonth()\n      );\n    });\n\n    const yearlyTrends = generateMonthlyTrends(yearlyBooks);\n    const genreBreakdown = generateGenreBreakdown(userBooks);\n    const readingStreak = calculateReadingStreak(userBooks);\n    const topRatedBooks = getTopRatedBooks(userBooks, 5);\n\n    const totalPagesRead = userBooks.reduce(\n      (sum, ub) => sum + (ub.books?.page_count || 0),\n      0\n    );\n\n    const averageRating =\n      userBooks.length > 0\n        ? userBooks.reduce((sum, ub) => sum + (ub.rating || 0), 0) /\n          userBooks.length\n        : 0;\n\n    return NextResponse.json({\n      yearlyTrends,\n      genreBreakdown,\n      readingStreak,\n      topRatedBooks,\n      totalBooksRead: userBooks.length,\n      totalPagesRead,\n      averageRating: Math.round(averageRating * 10) / 10,\n      thisMonthBooks: thisMonthBooks.length,\n      thisYearBooks: yearlyBooks.length,\n    });\n  } catch (error) {\n    console.error('Statistics error:', error);\n    return NextResponse.json(\n      { error: 'Failed to fetch statistics' },\n      { status: 500 }\n    );\n  }\n}\n\nfunction generateEmptyMonths(): MonthlyTrend[] {\n  const monthNames = [\n    'Jan',\n    'Feb',\n    'Mar',\n    'Apr',\n    'May',\n    'Jun',\n    'Jul',\n    'Aug',\n    'Sep',\n    'Oct',\n    'Nov',\n    'Dec',\n  ];\n\n  return monthNames.map((month) => ({\n    month,\n    booksRead: 0,\n    pagesRead: 0,\n  }));\n}\n\nfunction generateMonthlyTrends(books: UserBook[]): MonthlyTrend[] {\n  const monthlyData: Record<number, { books: number; pages: number }> = {};\n\n  for (let i = 0; i < 12; i++) {\n    monthlyData[i] = { books: 0, pages: 0 };\n  }\n\n  books.forEach((userBook) => {\n    if (userBook.completed_at) {\n      const month = new Date(userBook.completed_at).getMonth();\n      monthlyData[month].books += 1;\n      monthlyData[month].pages += userBook.books?.page_count || 0;\n    }\n  });\n\n  const monthNames = [\n    'Jan',\n    'Feb',\n    'Mar',\n    'Apr',\n    'May',\n    'Jun',\n    'Jul',\n    'Aug',\n    'Sep',\n    'Oct',\n    'Nov',\n    'Dec',\n  ];\n\n  return monthNames.map((month, index) => ({\n    month,\n    booksRead: monthlyData[index].books,\n    pagesRead: monthlyData[index].pages,\n  }));\n}\n\nfunction generateGenreBreakdown(books: UserBook[]): GenreStats[] {\n  const genreCounts: Record<string, number> = {};\n\n  books.forEach((userBook) => {\n    if (userBook.books?.genres && Array.isArray(userBook.books.genres)) {\n      userBook.books.genres.forEach((genre) => {\n        genreCounts[genre] = (genreCounts[genre] || 0) + 1;\n      });\n    }\n  });\n\n  const total = Object.values(genreCounts).reduce((sum, count) => sum + count, 0);\n\n  if (total === 0) return [];\n\n  return Object.entries(genreCounts)\n    .map(([genre, count]) => ({\n      genre,\n      count,\n      percentage: Math.round((count / total) * 100),\n    }))\n    .sort((a, b) => b.count - a.count)\n    .slice(0, 8);\n}\n\nfunction calculateReadingStreak(books: UserBook[]): number {\n  if (books.length === 0) return 0;\n\n  let streak = 0;\n  const today = new Date();\n  today.setHours(0, 0, 0, 0);\n\n  const sortedBooks = [...books].sort((a, b) => {\n    const dateA = a.completed_at\n      ? new Date(a.completed_at)\n      : new Date(0);\n    const dateB = b.completed_at\n      ? new Date(b.completed_at)\n      : new Date(0);\n    return dateB.getTime() - dateA.getTime();\n  });\n\n  const currentDate = new Date(today);\n\n  for (const book of sortedBooks) {\n    if (!book.completed_at) continue;\n\n    const bookDate = new Date(book.completed_at);\n    bookDate.setHours(0, 0, 0, 0);\n\n    if (bookDate.getTime() === currentDate.getTime()) {\n      streak += 1;\n      currentDate.setDate(currentDate.getDate() - 1);\n    } else if (bookDate.getTime() < currentDate.getTime()) {\n      break;\n    }\n  }\n\n  return streak;\n}\n\nfunction getTopRatedBooks(\n  books: UserBook[],\n  limit: number = 5\n): TopRatedBook[] {\n  return books\n    .filter((ub) => ub.rating && ub.rating > 0)\n    .sort((a, b) => (b.rating || 0) - (a.rating || 0))\n    .slice(0, limit)\n    .map((ub) => ({\n      title: ub.books?.title || 'Unknown',\n      rating: ub.rating || 0,\n      author: ub.books?.author || 'Unknown',\n    }));\n}\n"],"names":[],"mappings":"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"}}]
}