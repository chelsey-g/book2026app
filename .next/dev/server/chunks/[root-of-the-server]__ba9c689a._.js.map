{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/chelseygowac/book-tracker-app/src/app/api/profile-picture/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\nexport async function POST(request: NextRequest) {\n  try {\n    const authHeader = request.headers.get('authorization')\n    if (!authHeader?.startsWith('Bearer ')) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const token = authHeader.slice(7)\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      { global: { headers: { Authorization: `Bearer ${token}` } } }\n    )\n\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\n    if (authError || !user) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })\n    }\n\n    const formData = await request.formData()\n    console.log('Received FormData keys:', Array.from(formData.keys()))\n    const file = formData.get('profilePicture') as File\n\n    console.log('File received:', file ? { name: file.name, type: file.type, size: file.size } : 'null')\n\n    if (!file) {\n      return NextResponse.json({ error: 'No file provided' }, { status: 400 })\n    }\n\n    // Validate file type\n    const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp']\n    if (!allowedTypes.includes(file.type)) {\n      return NextResponse.json({ error: 'Invalid file type. Only JPEG, PNG, GIF, and WebP are allowed.' }, { status: 400 })\n    }\n\n    // Validate file size (max 5MB)\n    const maxSize = 5 * 1024 * 1024 // 5MB in bytes\n    if (file.size > maxSize) {\n      return NextResponse.json({ error: 'File too large. Maximum size is 5MB.' }, { status: 400 })\n    }\n\n    // Generate unique filename\n     const fileExt = file.name.split('.').pop()\n     const fileName = `${user.id}_${Date.now()}.${fileExt}`\n     const filePath = fileName\n\n    // Convert file to buffer for upload\n    const arrayBuffer = await file.arrayBuffer()\n    const buffer = Buffer.from(arrayBuffer)\n\n      const { data: uploadData, error: uploadError } = await supabase.storage\n        .from('avatar_images')\n        .upload(filePath, buffer, {\n          contentType: file.type,\n          upsert: true\n        })\n\n     if (uploadError) {\n       console.error('Upload error:', uploadError)\n       return NextResponse.json(\n         { error: `Upload failed: ${uploadError.message}` },\n         { status: 500 }\n       )\n     }\n\n      // Construct the public URL directly for public buckets\n      const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\n      if (!supabaseUrl) {\n        throw new Error('NEXT_PUBLIC_SUPABASE_URL is not set')\n      }\n      \n      // For public buckets, use the direct public URL format\n      const imageUrl = `${supabaseUrl}/storage/v1/object/public/avatar_images/${fileName}`\n\n      console.log('Constructed public URL:', imageUrl)\n\n      const { error: updateError } = await supabase\n        .from('users')\n        .update({ image: imageUrl })\n        .eq('id', user.id)\n        .select()\n\n      if (updateError) {\n      console.error('Database update error:', updateError)\n      try {\n        await supabase.storage\n          .from('avatar_images')\n          .remove([filePath])\n      } catch (e) {\n        console.error('Failed to clean up storage:', e)\n      }\n\n      return NextResponse.json({ error: 'Failed to update profile' + updateError.message }, { status: 500 })\n    }\n\n    try {\n      const updatedUser = await supabase\n        .from('users')\n        .select('image')\n        .eq('id', user.id)\n        .single()\n\n      console.log('Updated user image:', updatedUser.data?.image)\n\n      return NextResponse.json({\n        success: true,\n        profilePictureUrl: imageUrl\n      })\n    } catch (error) {\n      console.error('Profile picture upload error:', error)\n      const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n      return NextResponse.json(\n        { error: `Internal server error: ${errorMessage}` },\n        { status: 500 }\n      )\n    }\n\n   } catch (error) {\n     console.error('Profile picture upload error:', error)\n     const errorMessage = error instanceof Error ? error.message : 'Unknown error'\n     return NextResponse.json(\n       { error: `Internal server error: ${errorMessage}` },\n       { status: 500 }\n     )\n   }\n}\n"],"names":[],"mappings":"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"}}]
}