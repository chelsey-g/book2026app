{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/chelseygowac/book-tracker-app/src/app/api/books/bulk-import/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server'\nimport { createClient } from '@supabase/supabase-js'\n\ninterface BookData {\n  name: string\n  author: string\n  status: string\n  rating?: number\n  dateStarted?: string\n  dateFinished?: string\n  type?: string\n  cover?: string\n  apiId?: string\n  description?: string\n  publishedDate?: string\n  publisher?: string\n  categories?: string[]\n  year?: number\n}\n\nasync function searchBookAPI(title: string, author: string) {\n  try {\n    const response = await fetch(`${process.env.NEXT_PUBLIC_APP_URL}/api/books/search?title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}`)\n    if (!response.ok) return null\n    const data = await response.json()\n    return data.books?.[0] || null\n  } catch (error) {\n    console.error('Error searching book API:', error)\n    return null\n  }\n}\n\nfunction parseDate(dateString: string | undefined, year: number): string | null {\n  if (!dateString || dateString.trim() === '') return null\n\n  try {\n    const cleanedDate = dateString.replace(/(\\d+)(st|nd|rd|th)/g, '$1')\n    \n    const dateWithYear = `${cleanedDate} ${year}`\n    const parsed = new Date(dateWithYear)\n    \n    if (isNaN(parsed.getTime())) {\n      console.warn(`Could not parse date: \"${dateString}\"`)\n      return null\n    }\n    \n    return parsed.toISOString()\n  } catch (error) {\n    console.warn(`Error parsing date \"${dateString}\":`, error)\n    return null\n  }\n}\n\nasync function findOrCreateBook(supabase: any, bookData: BookData) {\n  const { data: existingBook } = await supabase\n    .from('books')\n    .select('*')\n    .eq('title', bookData.name)\n    .eq('author', bookData.author)\n    .single()\n\n  if (existingBook) {\n    return existingBook.id\n  }\n\n  let pageCount = null\n  \n  if (!bookData.apiId) {\n    const apiResult = await searchBookAPI(bookData.name, bookData.author)\n    if (apiResult) {\n      bookData.apiId = apiResult.id\n      bookData.cover = apiResult.coverUrl || apiResult.cover_url || apiResult.imageUrl\n      bookData.description = apiResult.description\n      bookData.publishedDate = apiResult.publishedDate || apiResult.published_date\n      bookData.publisher = apiResult.publisher\n      bookData.categories = apiResult.genres || apiResult.categories\n      pageCount = apiResult.pageCount || null\n    }\n  }\n\n  const { data: newBook, error } = await supabase\n    .from('books')\n    .insert({\n      title: bookData.name,\n      author: bookData.author,\n      description: bookData.description || '',\n      cover_url: bookData.cover || null,\n      page_count: pageCount,\n      genres: bookData.categories || [],\n      published_date: bookData.publishedDate || null,\n    })\n    .select('id')\n    .single()\n\n  if (error) {\n    throw new Error(`Failed to create book: ${error.message}`)\n  }\n\n  return newBook.id\n}\n\nasync function createOrUpdateUserBook(supabase: any, userId: string, bookId: string, bookData: BookData) {\n  const { data: existingUserBook } = await supabase\n    .from('user_books')\n    .select('*')\n    .eq('user_id', userId)\n    .eq('book_id', bookId)\n    .single()\n\n  const year = bookData.year || new Date().getFullYear()\n\n  const userBookData = {\n    status: bookData.status,\n    rating: bookData.rating || null,\n    started_at: parseDate(bookData.dateStarted, year),\n    completed_at: parseDate(bookData.dateFinished, year),\n  }\n\n  if (existingUserBook) {\n    const { error } = await supabase\n      .from('user_books')\n      .update(userBookData)\n      .eq('user_id', userId)\n      .eq('book_id', bookId)\n\n    if (error) {\n      throw new Error(`Failed to update user book: ${error.message}`)\n    }\n  } else {\n    const { error } = await supabase\n      .from('user_books')\n      .insert({\n        user_id: userId,\n        book_id: bookId,\n        ...userBookData,\n      })\n\n    if (error) {\n      throw new Error(`Failed to create user book: ${error.message}`)\n    }\n  }\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const authHeader = request.headers.get('authorization')\n    if (!authHeader?.startsWith('Bearer ')) {\n      return NextResponse.json(\n        { error: 'Unauthorized' },\n        { status: 401 }\n      )\n    }\n\n    const token = authHeader.slice(7)\n\n    const supabase = createClient(\n      process.env.NEXT_PUBLIC_SUPABASE_URL!,\n      process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!,\n      {\n        global: {\n          headers: {\n            Authorization: `Bearer ${token}`,\n          },\n        },\n      }\n    )\n\n    const { data: { user }, error: authError } = await supabase.auth.getUser()\n\n    if (authError || !user) {\n      return NextResponse.json(\n        { error: 'Unauthorized' },\n        { status: 401 }\n      )\n    }\n\n    const booksToImport: BookData[] = await request.json()\n\n    console.log('üì• Received books to import:', booksToImport.length)\n    console.log('üì• First book:', booksToImport[0])\n    console.log('üë§ User ID:', user.id)\n\n    if (!Array.isArray(booksToImport)) {\n      return NextResponse.json(\n        { error: 'Invalid request body: expected array of books' },\n        { status: 400 }\n      )\n    }\n\n    let successCount = 0\n    const errors: Array<{ book: string; error: string }> = []\n\n    for (const bookData of booksToImport) {\n      try {\n        console.log(`üîç Processing: \"${bookData.name}\" by \"${bookData.author}\"`)\n        \n        if (!bookData.name || !bookData.author) {\n          throw new Error('Missing required fields: name and author')\n        }\n\n        const bookId = await findOrCreateBook(supabase, bookData)\n        console.log(`‚úÖ Book created/found with ID: ${bookId}`)\n\n        await createOrUpdateUserBook(supabase, user.id, bookId, bookData)\n        console.log(`‚úÖ User-book entry created`)\n\n        successCount++\n      } catch (error) {\n        console.error(`‚ùå Error processing book \"${bookData.name}\":`, error)\n        errors.push({\n          book: bookData.name || 'Unknown',\n          error: error instanceof Error ? error.message : 'Unknown error'\n        })\n      }\n    }\n\n    console.log(`üìä Import complete: ${successCount}/${booksToImport.length} succeeded`)\n\n    return NextResponse.json({\n      success: true,\n      importedCount: successCount,\n      totalBooks: booksToImport.length,\n      errors: errors\n    })\n\n  } catch (error) {\n    console.error('Bulk import error:', error)\n    return NextResponse.json(\n      { \n        error: 'Internal server error',\n        details: error instanceof Error ? error.message : 'Unknown error'\n      },\n      { status: 500 }\n    )\n  }\n}\n"],"names":[],"mappings":"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"}}]
}